# Titan-Stream 重构计划（依据 FSMdesign.md）

## 目标与范围
- 以 Titan-Stream（M-Stream V9）为核心，重写模型与实验管线，支持在线惊奇度驱动的记忆更新与延迟反馈。
- 兼容现有 CLI（`run.py`）与数据管线，保留必要的旧模型但逐步收敛到统一框架。
- 清理无关/临时代码与缓存，降低认知负担。

## 阶段与里程碑（含当前进度）
1. **阶段0：梳理与清理** ✅ 已完成
   - 清理缓存与过时脚本，盘点现有入口与数据流。
2. **阶段1：核心模型落地** ✅ 已完成
   - `models/titan_stream.py`：实现三流结构（Neural Memory、Persistent Memory、Core Forecaster），支持代理重建、动量 + 门控在线更新。
3. **阶段2：训练管线重写** ⏳ 进行中（已落地基础版本）
   - 已接入 Titan 训练分支，支持按 batch 分块的累积、时间维 chunk_len、梯度裁剪、训练/验证记忆复位。高阶梯度开关参数已占位，实际二阶/长依赖求导仍待实现（当前默认一阶截断）。
4. **阶段3：在线推理与延迟反馈** ⏳ 进行中（近期更新）
   - 在线流程兼容 Titan（无 memory 属性），支持离线 checkpoint 回退加载；延迟缓冲权重与统计已接通，仍需强化对齐/权重策略与更多指标。
5. **阶段4：配置与集成** ⏳ 进行中
   - 扩展 CLI 参数（持久记忆大小、动量 lr、chunk_size/chunk_len、高阶开关、裁剪等），兼容现有数据管线。
6. **阶段5：评测与消融** ⏳ 待启动
   - 基线对比、消融（beta、eta、n_persistent、chunk_size、高阶开关），指标与可视化。
7. **阶段6：文档与交付** ⏳ 待启动
   - README/使用指南、迁移/弃用说明。

## 任务拆分（按阶段）
- 阶段0：删除 `__pycache__`/`.pyc`，移除过时实验脚本；列出现存入口/脚本。**状态：已完成**
- 阶段1：定义组件接口（MemoryState、PersistentMemory、CoreDecoder、GateNet），实现前向、代理重建与输出头。**状态：已完成**
- 阶段2：实现 Chunk 循环训练，学习率/优化器分组（记忆与核心可分 lr），加入梯度裁剪与数值保护；训练/验证前后重置记忆。**状态：进行中**
- 阶段3：实现在线循环、延迟反馈缓冲、惊奇度与门控更新，指标收集复用/扩展 `online_utils`。**状态：进行中（已接入在线分支，需完善缓冲策略与统计）**
- 阶段4：参数接入 `run.py`，新增脚本示例，确保与现有数据集接口兼容。**状态：进行中（已添加核心超参，待脚本示例与默认配置）**
- 阶段5：编写/运行对比脚本，产出指标与可视化；记录结果。**状态：待启动**
- 阶段6：整理文档、迁移指南、弃用说明。**状态：待启动**

## 风险与对策
- **内存/算力压力**：`M` 为 D×D，需支持降维/分块或低秩；默认 D 合理范围，启用梯度裁剪与混合精度可选。
- **高阶梯度爆炸**：默认关闭高阶，仅一阶截断；提供开关，限制 chunk_size。
- **门控/惊奇度不稳定**：对 `G/S` 做归一化与裁剪，门控输出夹紧；支持温度/EMA。
- **延迟反馈对齐**：明确缓冲窗口与对齐规则，缺标签时退化为代理更新（TODO：补充缓冲权重/对齐策略实现）。

## 近期优先事项
1) 落地 Titan 训练管线：chunk 化/截断、一阶代理+预测联合训练，记忆复位钩子。  
2) 打通在线评测：延迟反馈缓冲对齐、指标与可视化输出，默认无高阶梯度。  
3) 提供示例脚本与默认配置，运行一版小数据集验证训练/在线流程。  
