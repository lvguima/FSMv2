# Titan-Stream 重构计划（依据 FSMdesign.md）

## 目标与范围
- 以 Titan-Stream（M-Stream V9）为核心，重写模型与实验管线，支持在线惊奇度驱动的记忆更新与延迟反馈。
- 兼容现有 CLI（`run.py`）与数据管线，保留必要的旧模型但逐步收敛到统一框架。
- 清理无关/临时代码与缓存，降低认知负担。

## 阶段与里程碑（含当前进度）
1. **阶段0：梳理与清理** ✅ 已完成
   - 清理缓存与过时脚本，盘点现有入口与数据流。
2. **阶段1：核心模型落地** ✅ 已完成
   - `models/titan_stream.py`：实现三流结构（Neural Memory、Persistent Memory、Core Forecaster），支持代理重建、动量 + 门控在线更新。
3. **阶段2：训练管线重写** ⏳ 进行中（基础版完成）
   - 已接入 Titan 训练分支：batch 分块、时间片 `chunk_len`、梯度裁剪、train/val 记忆复位，`use_high_order` 允许跨时间片保留图；真正的二阶/元学习（梯度通过记忆更新）尚未实现。
4. **阶段3：在线推理与延迟反馈** ⏳ 进行中
   - 在线兼容 Titan，无 `memory` 属性仍可运行；支持离线 checkpoint 回退。延迟缓冲加入温度、异常加权、最小样本门槛与丰富统计，但惊奇度/异常触发仍基于 proxy loss，未与外部异常信号联动。
5. **阶段4：配置与集成** ⏳ 进行中
   - CLI 已覆盖 Titan 与延迟反馈/高阶超参；脚本示例提供 ETTh1/ETTm1_Online（含延迟反馈）。
6. **阶段5：评测与消融** ⏳ 待启动
   - 需要跑基线对比与消融（beta、eta、n_persistent、chunk_size/chunk_len、use_high_order、延迟权重/温度/异常加权），输出指标与可视化。
7. **阶段6：文档与交付** ⏳ 待启动
   - README/设计说明更新、使用指南与迁移/弃用说明。

## 任务拆分（按阶段）
- 阶段0：删除 `__pycache__`/`.pyc`，移除过时实验脚本；列出现存入口/脚本。**状态：已完成**
- 阶段1：定义组件接口（MemoryState、PersistentMemory、CoreDecoder、GateNet），实现前向、代理重建与输出头。**状态：已完成**
- 阶段2：实现 Chunk 循环训练，学习率/优化器分组（记忆与核心可分 lr），加入梯度裁剪与数值保护；训练/验证前后重置记忆。**状态：进行中**
- 阶段3：实现在线循环、延迟反馈缓冲、惊奇度与门控更新，指标收集复用/扩展 `online_utils`。**状态：进行中（已接入在线分支，需完善缓冲策略与统计）**
- 阶段4：参数接入 `run.py`，新增脚本示例，确保与现有数据集接口兼容。**状态：进行中（已添加核心超参，待脚本示例与默认配置）**
- 阶段5：编写/运行对比脚本，产出指标与可视化；记录结果。**状态：待启动**
- 阶段6：整理文档、迁移指南、弃用说明。**状态：待启动**

## 风险与对策
- **内存/算力压力**：`M` 为 D×D，需支持降维/分块或低秩；默认 D 合理范围，启用梯度裁剪与混合精度可选。
- **高阶梯度爆炸**：默认关闭高阶，仅一阶截断；提供开关，限制 chunk_size。
- **门控/惊奇度不稳定**：对 `G/S` 做归一化与裁剪，门控输出夹紧；支持温度/EMA。
- **延迟反馈对齐**：明确缓冲窗口与对齐规则，缺标签时退化为代理更新（TODO：补充缓冲权重/对齐策略实现）。

## 近期优先事项
1) 落地 Titan 训练管线：chunk 化/截断、一阶代理+预测联合训练，记忆复位钩子。  
2) 打通在线评测：延迟反馈缓冲对齐、指标与可视化输出，默认无高阶梯度。  
3) 提供示例脚本与默认配置，运行一版小数据集验证训练/在线流程。  
